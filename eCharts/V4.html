<!DOCTYPE html>
<html style="height: 100%;">

<head>
  <title>Testing eCharts - V4</title>
  <meta charset="utf-8" />
</head>
<!-- 
   TODOs for now: finetuning of the chart display: axis label, tooltip, etc.


  Idea for V5: select fields to plot in x and y axis via dropdowns 
   TODOs:
   add logic to this form
   retrieve all theses fields from JSON in fetchData
   eCharts: set axis label according to selected data field

   Idea for V6 preselect 20 countries for plot, but offer to select from all available countries
   TODOs:
   preselect 20 countries via hard coded list or via fetching from some JSON
   How to select from all countries? Maybe group by Continent (available in countries-latest-all.json)
  -->

<body style="height: 100%; margin: 0;">
  <!-- <script src="lib/echarts-en.js"></script> -->
  <script src="lib/echarts-en.min.js"></script>
  <script type="text/javascript" src="lib/jquery-3.5.0.min.js"></script>
  <form> TODO: How to select contries?<br />
    <!-- TODO: convert to table layout --> TODO: x axis: <select id="sel_x_axis_field" name="sel_x_axis_field">
      <option value="Days_Past">Days Past</option>
      <option value="Days_Since_2_Deaths">Days Since 2nd Death</option>
      <!-- <option value="Date ">Date</option> -->
    </select>
    <select id="sel_x_axis_scale" name="sel_x_axis_scale">
      <option value="linscale">linear</option>
      <option value="logscale">logarithmic</option>
    </select>
    <br /> TODO: y axis: <select id="sel_y_axis_row" name="y-Axis">
      <option value="Cases">Cases</option>
      <option value="Deaths">Deaths</option>
      <option value="Cases_New">Cases new</option>
      <option value="Deaths_New">Deaths new</option>
      <option value="Cases_Last_Week">Cases last week</option>
      <option value="Deaths_Last_Week">Deaths last week</option>
      <option value="Cases_Per_Million">Cases per million population</option>
      <option value="Deaths_Per_Million">Deaths per million population</option>
      <option value="Cases_New_Per_Million">Cases new per million population</option>
      <option value="Deaths_New_Per_Million">Deaths new per million population</option>
      <option value="Cases_Last_Week_Per_Million">Cases last week per million population</option>
      <option value="Deaths_Last_Week_Per_Million">Deaths last week per million population</option>
      <option value="Cases_Doubling_Time">Cases doubling time</option>
      <option value="Deaths_Doubling_Time">Deaths doubling time</option>
    </select>
    <select id="sel_y_axis_scale" name="sel_y_axis_scale">
      <option value="linscale">linear</option>
      <option value="logscale">logarithmic</option>
    </select>
  </form>
  <div id="container" style="height: 100%;"></div>
  <!--  -->
  <!-- <script scr="lib/V1.js"></script> -->
  <script type="text/javascript">
    console.log("Start");

    // array of promises for async fetching
    const promises = [];


    // new by Torben
    // fetch ref list: Country Code -> Country Name
    // 
    var countryNames = {};
    function fetchCountryNames(countryNames) {
      const url = 'https://entorb.net/COVID-19-coronavirus/data/int/countries-latest-all.json';
      return $.getJSON(url, (data) => {
        console.log('success: countryNames');
      })
        .done((data) => {
          console.log('done: countryNames');
          $.each(data, function (key, val) {
            countryNames[data[key].Code] = data[key].Country;
          });
          return countryNames;
        })
        .fail(() => {
          console.log('fail: countryNames');
        });
    }

    // fetch the ref data
    promises.push(fetchCountryNames(countryNames));


    const countryCodes = ["DE", "HU", "SE", "ES", "US"]; // Adding a new country code to this array draws a new line
    const lines = {}; // We store all the data in an object

    // Fetches the data for one country code
    // countryCode: the code of the country e.g. "DE"
    // lines: the object where the line for each country is
    function fetchData(countryCode, lines) {
      const url = getUrl(countryCode);
      // AAN: I like using "() => {}" lambda expressions instead of "function () {}" as parameters
      return $.getJSON(url, (data) => {
        console.log(`success: ${countryCode}`);
      })
        .done((data) => {
          console.log(`done: ${countryCode}`);
          lines[countryCode] = [];
          $.each(data, function (key, val) {
            lines[countryCode].push([data[key].Days_Past, data[key].Cases]);
          });
          return lines;
        })
        .fail(() => {
          console.log(`fail: ${countryCode}`);
        });
    }

    // Gets the url of the given country
    // countryCode: the code of the country e.g. "DE"
    function getUrl(country_code) {
      // `words${variable}words` syntax is more readable than "words" + variable + "words"
      return `https://entorb.net/COVID-19-coronavirus/data/int/country-${country_code}.json`;
    }

    // Gets the series property of the chart object
    function getSeries() {
      const series = [];
      for (let i = 0; i < countryCodes.length; i++) {
        const seria = {
          data: lines[countryCodes[i]], // the line of the country
          name: countryNames[countryCodes[i]],
          type: "line",
          symbolSize: 5,
        };
        series.push(seria);
      }
      return series;
    }

    const dom = document.getElementById("container");
    const myChart = echarts.init(dom);


    // For each country code we fetch the data
    for (let i = 0; i < countryCodes.length; i++) {
      promises.push(fetchData(countryCodes[i], lines));
    }


    // Wait for all async promises to be done (all data is fetched), than set the option of the chart
    Promise.all(promises).then(() => {
      console.log("All data fetched");
      option = {
        title: {
          text: "My Title",
          subtext: "My Subtext"
        },
        legend: {
          type: 'scroll',
          orient: 'vertical',
          right: 0,
          top: 50,
          //          bottom: 20,
        },
        xAxis: {
          name: "Days Past",
          type: "value",
          nameTextStyle: { fontWeight: "bold" },
          nameLocation: "middle",
          minorTick: { show: true },
          minorSplitLine: {
            show: true
          }
        },
        // in type log : setting min is required
        yAxis: {
          name: "Cases",
          type: "log", //value or log
          min: 1,
          //          max: 10000,
          nameTextStyle: { fontWeight: "bold" },
          nameLocation: "center",
          minorTick: { show: true },
          minorSplitLine: {
            show: true
          }
        }, //max: "dataMax"
        series: getSeries(),
        tooltip: {
          trigger: 'item', // item or axis
          axisPointer: {
            type: 'shadow'
          }
        },
        toolbox: {
          show: true,
          showTitle: true,
          feature: {
            saveAsImage: {},
            // restore: {},
            dataZoom: {},
            dataView: { readOnly: true },
            // magicType: {
            //  type: ['line', 'bar', 'stack', 'tiled']
            //},
            //brush: {},
          },
        }
      };
      myChart.setOption(option, true);
    });
  </script>
</body>

</html>