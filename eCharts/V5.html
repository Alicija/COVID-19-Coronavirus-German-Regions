<!DOCTYPE html>
<html style="height: 100%;">

<head>
  <title>Testing eCharts - V5</title>
  <meta charset="utf-8" />
  <script src="lib/echarts-en.min.js"></script>
  <script type="text/javascript" src="lib/jquery-3.5.0.min.js"></script>
  <script src="lib/utils.js"></script>
</head>
<!-- 
  Idea for V5: select fields to plot in x and y axis via dropdowns 
   DONE
    by AAN: add logic to this form
    by AAN: retrieve all theses fields from JSON in fetchData
    eCharts: set axis label according to selected data field
    implement linscale and logscale
    Add Date as X axis
   

   Idea for V6 preselect 20 countries for plot, but offer to select from all available countries
   TODOs:
   preselect 20 countries via hard coded list or via fetching from some JSON
   How to select from all countries? Maybe one dropdown per continent (continent is available in countries-latest-all.json) 
  -->

<body style="height: 100%; margin: 0;">
  <form>
    <table>
      <tr>
        <td>
          <label>x axis:</label>
        </td>
        <td>
          <select id="sel_x_axis_field" name="sel_x_axis_field"> </select>
        </td>
        <td> &nbsp;
          <!-- 
            <select id="sel_x_axis_scale" name="sel_x_axis_scale">
            </select>
          -->
        </td>
      </tr>
      <tr>
        <td>y axis:</td>
        <td>
          <select id="sel_y_axis_field" name="sel_y_axis_field"> </select>
        </td>
        <td> <select id="sel_y_axis_scale" name="sel_y_axis_scale"> </select>
        </td>
      </tr>
    </table>

    <p>TODOs:<br /> Choose from all countries of the world</p>
    <select id="sel_countries_europe" name="sel_countries_europe"> </select>
  </form>
  <!-- 
    End Form 
  -->
  <div id="container" style="height: 100%;"></div>
</body>
<script type="text/javascript">
  // array of promises for async fetching
  const promises = [];

  // fetch ref list: Country Code -> Country Name
  var mapCountryNames = {};
  function fetch_mapCountryNames(mapCountryNames) {
    const url =
      "https://entorb.net/COVID-19-coronavirus/data/int/countries-latest-all.json";
    return $.getJSON(url, (data) => {
      console.log("success: mapCountryNames");
    })
      .done((data) => {
        console.log("done: mapCountryNames");
        $.each(data, function (key, val) {
          mapCountryNames[data[key].Code] = data[key].Country;
        });
        return mapCountryNames;
      })
      .fail(() => {
        console.log("fail: mapCountryNames");
      });
  }

  // fetch the ref data
  promises.push(fetch_mapCountryNames(mapCountryNames));

  const options_axis_scales = [
    { value: "logscale", text: "logarithmic" },
    { value: "linscale", text: "linear" },
  ];

  const options_xAxisProperty = ["Date", "Days_Since_2_Deaths", "Days_Past"];
  const options_yAxisProperty = [
    "Deaths_Per_Million",
    "Deaths_Last_Week_Per_Million",
    "Deaths_New_Per_Million",
    "Deaths",
    "Deaths_Last_Week",
    "Deaths_New",
    "Deaths_Doubling_Time",
    "Cases_Per_Million",
    "Cases_Last_Week_Per_Million",
    "Cases_New_Per_Million",
    "Cases",
    "Cases_Last_Week",
    "Cases_New",
    "Cases_Doubling_Time",
  ];

  // TODO: fill by countries-latest-all.json
  const options_countries_europe = [
    { value: "GB", text: "United Kingdom" },
    { value: "IE", text: "Ireland" },
  ];


  // axis selects
  const select_xAxisProperty = document.getElementById("sel_x_axis_field");
  const select_yAxisProperty = document.getElementById("sel_y_axis_field");
  // const xAxisScaleSelect = document.getElementById("sel_x_axis_scale");
  const select_yAxisScale = document.getElementById("sel_y_axis_scale");

  // country selects
  const select_countries_europe = document.getElementById("sel_countries_europe");

  // Set the options of the selects
  addOptionsToSelect(select_xAxisProperty, options_xAxisProperty);
  addOptionsToSelect(select_yAxisProperty, options_yAxisProperty);
  // addOptionsToSelect(xAxisScaleSelect, options_axis_scales);
  addOptionsToSelect(select_yAxisScale, options_axis_scales);

  addOptionsToSelect(select_countries_europe, options_countries_europe);

  // If the value of a select changes refresh the chart
  // TODO: add xAxisScaleSelect and select_yAxisScale value to logic
  select_xAxisProperty.onchange = () => refreshChartWrapper();
  select_yAxisProperty.onchange = () => refreshChartWrapper();
  // xAxisScaleSelect.onchange = () => refreshChartWrapper();
  select_yAxisScale.onchange = () => refreshChartWrapper();
  select_countries_europe.onchange = () => refreshChartWrapper();

  // Adding a new country code to this array draws a new line
  // TODO: shall we add all countries manually to this list, but disabling their series? Probable not, as then they would be downloaded. better use a dropbox to add a country to the list
  const countryCodes = ["DE", "HU", "IT", "ES", "FR", "BE", "CH", "JP", "CZ", "US"];
  const countriesDataObject = {}; // We store all the data in an object

  const dom = document.getElementById("container");
  const myChart = echarts.init(dom);

  // For each country code we fetch the data
  for (let i = 0; i < countryCodes.length; i++) {
    promises.push(fetchData(countryCodes[i], countriesDataObject));
  }

  // Wait for all async promises to be done (all data is fetched), then refreshes the chart
  Promise.all(promises).then(() => {
    console.log("All data fetched");
    refreshChartWrapper();
  });

  // Wraps the refreshChart function so it is more readable, takes less space
  function refreshChartWrapper() {
    refreshChart(
      myChart,
      countryCodes,
      countriesDataObject,
      select_xAxisProperty,
      select_yAxisProperty,
      select_yAxisScale
    );
  }
</script>

</html>