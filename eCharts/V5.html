<!DOCTYPE html>
<html style="height: 100%;">

<head>
  <title>Testing eCharts - V5</title>
  <meta charset="utf-8" />
  <script src="lib/echarts-en.min.js"></script>
  <script type="text/javascript" src="lib/jquery-3.5.0.min.js"></script>
  <script src="lib/utils.js"></script>
</head>
<!-- 
  Idea for V5: select fields to plot in x and y axis via dropdowns 
   DONE
    by AAN: add logic to this form
    by AAN: retrieve all theses fields from JSON in fetchData
    eCharts: set axis label according to selected data field
    implement linscale and logscale
    Add Date as X axis
   

   Idea for V6 preselect 20 countries for plot, but offer to select from all available countries
   TODOs:
   preselect 20 countries via hard coded list or via fetching from some JSON
   How to select from all countries? Maybe one dropdown per continent (continent is available in countries-latest-all.json) 
  -->

<body style="height: 100%; margin: 0;">
  <form>

    <h3>1. Select countries</h3>
    <table>
      <tr>
        <th>Africa</th>
        <th>Asia</th>
        <th>Europe</th>
        <th>North America</th>
        <th>South America</th>
        <th>Oceania</th>
      </tr>
      <tr>
        <td>
          <select id="sel_countries_africa" name="sel_countries_africa"> </select>
        </td>
        <td>
          <select id="sel_countries_asia" name="sel_countries_asia"> </select>
        </td>
        <td>
          <select id="sel_countries_europe" name="sel_countries_europe"> </select>
        </td>
        <td>
          <select id="sel_countries_north_america" name="sel_countries_north_america"> </select>
        </td>
        <td>
          <select id="sel_countries_south_america" name="sel_countries_south_america"> </select>
        </td>
        <td>
          <select id="sel_countries_oceania" name="sel_countries_oceania"> </select>
        </td>
      </tr>
    </table>

    <h3>2. Select data</h3>
    <table>
      <tr>
        <td>
          <label>x axis:</label>
        </td>
        <td>
          <select id="sel_x_axis_field" name="sel_x_axis_field"> </select>
        </td>
        <td> &nbsp;
          <!-- 
            <select id="sel_x_axis_scale" name="sel_x_axis_scale">
            </select>
          -->
        </td>
      </tr>
      <tr>
        <td>y axis:</td>
        <td>
          <select id="sel_y_axis_field" name="sel_y_axis_field"> </select>
        </td>
        <td> <select id="sel_y_axis_scale" name="sel_y_axis_scale"> </select>
        </td>
      </tr>
    </table>
  </form>
  <!-- 
    End Form 
  -->
  <div id="container" style="height: 75%;"></div>
</body>
<script type="text/javascript">
  // array of promises for async fetching
  const promises = [];

  // fetch ref list: Country Code -> Country Name
  var mapCountryNames = {};
  var mapContinentCountries = {};
  function fetch_mapRefCountryData(mapCountryNames, mapContinentCountries) {
    const url =
      "https://entorb.net/COVID-19-coronavirus/data/int/countries-latest-all.json";
    return $.getJSON(url, (data) => {
      console.log("success: mapCountryNames");
    })
      .done((data) => {
        console.log("done: mapCountryNames");
        $.each(data, function (key, val) {
          mapCountryNames[data[key].Code] = data[key].Country;
          const this_continent = data[key].Continent;
          if (!(this_continent in mapContinentCountries)) {
            mapContinentCountries[this_continent] = [];
          }
          mapContinentCountries[this_continent].push([data[key].Code, data[key].Country]);  // pair of country_code , country_name
        });
      })
      .fail(() => {
        console.log("fail: mapCountryNames");
      });
  }

  // fetch the ref data
  promises.push(fetch_mapRefCountryData(mapCountryNames, mapContinentCountries));

  const options_axis_scales = [
    { value: "logscale", text: "logarithmic" },
    { value: "linscale", text: "linear" },
  ];

  const options_xAxisProperty = ["Date", "Days_Since_2nd_Death", "Days_Past"];
  const options_yAxisProperty = [
    "Deaths_Per_Million",
    "Deaths_Last_Week_Per_Million",
    "Deaths_New_Per_Million",
    "Deaths",
    "Deaths_Last_Week",
    "Deaths_New",
    "Deaths_Doubling_Time",
    "Cases_Per_Million",
    "Cases_Last_Week_Per_Million",
    "Cases_New_Per_Million",
    "Cases",
    "Cases_Last_Week",
    "Cases_New",
    "Cases_Doubling_Time",
  ];

  // fill by data fetched from countries-latest-all.json
  var options_countries_africa = [];
  var options_countries_asia = [];
  var options_countries_europe = [];
  var options_countries_north_america = [];
  var options_countries_south_america = [];
  var options_countries_oceania = [];


  // axis selects
  // const xAxisScaleSelect = document.getElementById("sel_x_axis_scale");
  const select_yAxisScale = document.getElementById("sel_y_axis_scale");
  const select_xAxisProperty = document.getElementById("sel_x_axis_field");
  const select_yAxisProperty = document.getElementById("sel_y_axis_field");

  // country selects
  const select_countries_africa = document.getElementById("sel_countries_africa");
  const select_countries_asia = document.getElementById("sel_countries_asia");
  const select_countries_europe = document.getElementById("sel_countries_europe");
  const select_countries_north_america = document.getElementById("sel_countries_north_america");
  const select_countries_south_america = document.getElementById("sel_countries_south_america");
  const select_countries_oceania = document.getElementById("sel_countries_oceania");

  // Set the array options to the selects
  setOptionsToSelect(select_xAxisProperty, options_xAxisProperty, "");
  setOptionsToSelect(select_yAxisProperty, options_yAxisProperty, "");
  // setOptionsToSelect(xAxisScaleSelect, options_axis_scales);
  setOptionsToSelect(select_yAxisScale, options_axis_scales, "");

  // If the value of a select changes refresh the chart
  // TODO: add xAxisScaleSelect and select_yAxisScale value to logic
  select_xAxisProperty.onchange = () => refreshChartWrapper();
  select_yAxisProperty.onchange = () => refreshChartWrapper();
  // xAxisScaleSelect.onchange = () => refreshChartWrapper();
  select_yAxisScale.onchange = () => refreshChartWrapper();
  // countries
  select_countries_africa.onclick = () => new_country_selected(countryCodes, select_countries_africa, options_countries_africa);
  select_countries_asia.onclick = () => new_country_selected(countryCodes, select_countries_asia, options_countries_asia);
  select_countries_europe.onclick = () => new_country_selected(countryCodes, select_countries_europe, options_countries_europe);
  select_countries_north_america.onclick = () => new_country_selected(countryCodes, select_countries_north_america, options_countries_north_america);
  select_countries_south_america.onclick = () => new_country_selected(countryCodes, select_countries_south_america, options_countries_south_america);
  select_countries_oceania.onclick = () => new_country_selected(countryCodes, select_countries_oceania, options_countries_oceania);

  // Initial list of country codes
  // Adding a new country code to this array draws a new line
  var countryCodes = ["DE"];


  function new_country_selected(countryCodes, select_country, options_countries) {
    if (select_country.value != "placeholder123") {
      var country_code_to_add = select_country.value;
      console.log(country_code_to_add)

      // append to list of country codes
      countryCodes.push(country_code_to_add);

      // start fetching / download of data
      promises.push(fetchData(country_code_to_add, countriesDataObject))

      // remove selected values from options_countries
      arrayRemoveValueTextPairByValue(options_countries, country_code_to_add)
      setOptionsToSelect(select_country, options_countries, "Choose");

      // wait for fetching to complete, than update chart
      Promise.all(promises).then(() => {
        refreshChartWrapper();
      });
    }
  }

  const countriesDataObject = {}; // We store all the data in an object

  const dom = document.getElementById("container");
  const myChart = echarts.init(dom);

  // For each country code we fetch the data
  for (let i = 0; i < countryCodes.length; i++) {
    promises.push(fetchData(countryCodes[i], countriesDataObject));
  }

  // Wait for all async promises to be done (all data is fetched), then refreshes the chart
  Promise.all(promises).then(() => {
    console.log("All data fetched");

    // populate country select dropdown


    // // Europa
    // for (let i = 0; i < mapContinentCountries['Europe'].length; i++) {
    //   const code = mapContinentCountries['Europe'][i][0];
    //   const name = mapContinentCountries['Europe'][i][1]
    //   if (!(countryCodes.includes(code))) {
    //     options_countries_europe.push(
    //       { value: code, text: name }
    //     );
    //   }
    // }
    // setOptionsToSelect(select_countries_europe, options_countries_europe, "Choose");


    // Africa
    for (let i = 0; i < mapContinentCountries['Africa'].length; i++) {
      const code = mapContinentCountries['Africa'][i][0];
      const name = mapContinentCountries['Africa'][i][1]
      if (!(countryCodes.includes(code))) {
        options_countries_africa.push(
          { value: code, text: name }
        );
      }
    }
    setOptionsToSelect(select_countries_africa, options_countries_africa, "Choose");
    // Asia
    for (let i = 0; i < mapContinentCountries['Asia'].length; i++) {
      const code = mapContinentCountries['Asia'][i][0];
      const name = mapContinentCountries['Asia'][i][1]
      if (!(countryCodes.includes(code))) {
        options_countries_asia.push(
          { value: code, text: name }
        );
      }
    }
    setOptionsToSelect(select_countries_asia, options_countries_asia, "Choose");
    // Europe
    for (let i = 0; i < mapContinentCountries['Europe'].length; i++) {
      const code = mapContinentCountries['Europe'][i][0];
      const name = mapContinentCountries['Europe'][i][1]
      if (!(countryCodes.includes(code))) {
        options_countries_europe.push(
          { value: code, text: name }
        );
      }
    }
    setOptionsToSelect(select_countries_europe, options_countries_europe, "Choose");
    // North America
    for (let i = 0; i < mapContinentCountries['North America'].length; i++) {
      const code = mapContinentCountries['North America'][i][0];
      const name = mapContinentCountries['North America'][i][1]
      if (!(countryCodes.includes(code))) {
        options_countries_north_america.push(
          { value: code, text: name }
        );
      }
    }
    setOptionsToSelect(select_countries_north_america, options_countries_north_america, "Choose");
    // South America
    for (let i = 0; i < mapContinentCountries['South America'].length; i++) {
      const code = mapContinentCountries['South America'][i][0];
      const name = mapContinentCountries['South America'][i][1]
      if (!(countryCodes.includes(code))) {
        options_countries_south_america.push(
          { value: code, text: name }
        );
      }
    }
    setOptionsToSelect(select_countries_south_america, options_countries_south_america, "Choose");
    // Oceania
    for (let i = 0; i < mapContinentCountries['Oceania'].length; i++) {
      const code = mapContinentCountries['Oceania'][i][0];
      const name = mapContinentCountries['Oceania'][i][1]
      if (!(countryCodes.includes(code))) {
        options_countries_oceania.push(
          { value: code, text: name }
        );
      }
    }
    setOptionsToSelect(select_countries_oceania, options_countries_oceania, "Choose");

    refreshChartWrapper();
  });

  // Wraps the refreshChart function so it is more readable, takes less space
  function refreshChartWrapper() {
    refreshChart(
      myChart,
      countryCodes,
      countriesDataObject,
      select_xAxisProperty,
      select_yAxisProperty,
      select_yAxisScale
    );
  }
</script>

</html>