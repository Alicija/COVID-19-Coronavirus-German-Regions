<!DOCTYPE html>
<html style="height: 100%;">

<head>
  <title>Testing eCharts - V3</title>
  <meta charset="utf-8" />
</head>

<body style="height: 100%; margin: 0;">
  <div id="container" style="height: 100%;"></div>
  <script src="lib/echarts-en.min.js"></script>
  <script type="text/javascript" src="lib/jquery-3.5.0.min.js"></script>
  <!--  -->
  <!-- <script scr="lib/V1.js"></script> -->
  <script type="text/javascript">
    console.log("Start");
    const countryCodes = ["DE", "HU", "SE"]; // Adding a new country code to this array draws a new line
    const lines = {}; // We store all the data in an object

    // Fetches the data for one country code
    // countryCode: the code of the country e.g. "DE"
    // lines: the object where the line for each country is
    function fetchData(countryCode, lines) {
      const url = getUrl(countryCode);
      // I like using "() => {}" lambda expressions instead of "function () {}" as parameters
      return $.getJSON(url, (data) => {
        console.log(`success: ${countryCode}`);
      })
        .done((data) => {
          console.log(`done: ${countryCode}`);
          lines[countryCode] = [];
          $.each(data, function (key, val) {
            lines[countryCode].push([data[key].Days_Past, data[key].Cases]);
          });
          return lines;
        })
        .fail(() => {
          console.log(`fail: ${countryCode}`);
        });
    }

    // Gets the url of the given country
    // countryCode: the code of the country e.g. "DE"
    function getUrl(country_code) {
      // `words${variable}words` syntax is more readable than "words" + variable + "words"
      return `https://entorb.net/COVID-19-coronavirus/data/int/country-${country_code}.json`;
    }

    // Gets the series property of the chart object
    function getSeries() {
      const series = [];
      for (let i = 0; i < countryCodes.length; i++) {
        const seria = {
          data: lines[countryCodes[i]], // the line of the country
          name: countryCodes[i],
          type: "scatter",
        };
        series.push(seria);
      }
      return series;
    }

    const dom = document.getElementById("container");
    const myChart = echarts.init(dom);
    const promises = [];

    // For each country code we fetch the data
    for (let i = 0; i < countryCodes.length; i++) {
      promises.push(fetchData(countryCodes[i], lines));
    }

    // When all of the promises are done (all data are fetched) sets te option of the chart
    Promise.all(promises).then(() => {
      console.log("All data fetched");
      option = {
        xAxis: {},
        yAxis: {},
        series: getSeries(),
      };
      myChart.setOption(option, true);
    });
  </script>
</body>

</html>